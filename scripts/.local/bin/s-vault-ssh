#!/bin/bash
VAULT_CONFIG="$HOME/.config/local/vault-config"
PASS_FILE="$HOME/.config/local/vault-pass"

if [[ ! -f "$PASS_FILE" ]]; then
    echo "Vault lösenord saknas i $PASS_FILE"
    exit 1
fi

if [[ ! -f "$VAULT_CONFIG" ]]; then
    echo "Vault config saknas i $VAULT_CONFIG"
    exit 1
fi

source "$VAULT_CONFIG"

_vault_host=$(echo "${VAULT_HOSTS}" | awk '{print $1}')
export VAULT_ADDR="http://${_vault_host}:8200"

VAULT_TOKEN=$(vault login -method=userpass -field=token \
    username="${VAULT_USER}" \
    password="$(tr -d '\n' < "$PASS_FILE")" 2>/dev/null)

if [[ -z "$VAULT_TOKEN" ]]; then
    echo "Vault login misslyckades"
    exit 1
fi

export VAULT_TOKEN

# Ladda SSH-nycklar i agent från disk
for key in personal work school; do
    [[ -f "$HOME/.ssh/keys/$key" ]] && ssh-add "$HOME/.ssh/keys/$key" 2>/dev/null || true
done
